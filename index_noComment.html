<head>
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <script src="./script/jquery.js"></script>
   <script src="./script/grt-youtube-popup.js"></script>
   <script src="./script/jquery.mobile-1.4.5.js"></script>
   <script src="./script/jquery.validate.js"></script>
   <script type="text/javascript" charset="utf8" src="./script/jquery.dataTables.js"></script>
   <script src="./script/jquery-confirm.min.js"></script>
   <link rel="stylesheet" href="./script/jquery.mobile-1.4.5.css">
   <link rel="stylesheet" href="./script/grt-youtube-popup.css">
   <link rel="stylesheet" type="text/css" href="./script/jquery.dataTables.css">
   <link rel="stylesheet" href="./script/jquery-confirm.min.css">
   <script>
      function resetForm() {
         $("#fcreate")[0].reset();
      };
      
      $.validator.setDefaults({
         submitHandler: function() {
            $.confirm(
               {
                  smoothContent: true,
                  draggable: true,
                  boxWidth: '100%',
                  title: 'Please confirm submission',
                  content: ''+
                  'name: ' + $("#name").val() +
                  '<br> Property type: ' + $("#type").val()+
                  '<br>Rent price: ' + $("#rentprice").val()+
                  '<br>No. of bedroom: ' + $("#bedroom").val()+
                  '<br>Adding date: ' + $("#adddate").val()+
                  '<br>Adding time: ' + $("#addtime").val()+
                  '<br>Furniture: ' + $("#furniture").val()+
                  '<br>Note: ' + $("#note").val()+   
                  '<br>Youtube: ' + $("#link").val()+ 
                  '<br>Photo: ' + $("#photosrc").val(),   
                  buttons: 
                  {
                     confirm: function () 
                     {
                        insertrecord()
                     },
                     cancel: function () 
                     {
                        $.alert('Canceled!');
                     },
                  }
               });}});
           
      var DBName = 'RentalZdb';  
      var Version = 1;  
      var DBDesc = 'PropertyInfo';  
      var DBsize = 5 * 1024 * 1024;  
      var dbObj = openDatabase(DBName, Version, DBDesc, DBsize); 
      var dbtablecount = 0;
      var id_select = 0;
      var rowselected = false;
      var table;
       
      $(document).ready(function() 
      {
         $("#fcreate").validate();   
         dbObj.transaction(function (tx)  
         {  
            tx.executeSql('create table if not exists Property_table (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT, type TEXT, price INTEGER, bedroom INTEGER, adddate DATE, addtime INTEGER, furniture TEXT, note VARCHAR, ylink VARCHAR, photosrc VARCHAR)');  
         },dbError,function(tx) {});
      })     
            
      function dbError(e) 
      {
         console.log("Error", e);
      }  
      
      function insertrecord()
      {
         var name= $("#name").val();
         var type = $("#type").val();
         var rentprice = $("#rentprice").val();
         var bedroom  = $("#bedroom").val();
         var adddate  = $("#adddate").val();
         var addtime  = $("#addtime").val();
         var furniture  = $("#furniture").val();
         var note  = $("#note").val();
         var link = $("#link").val();
         var photosrc = $("#photosrc").val();
                  
         dbObj.transaction(function(tx) 
         {
            tx.executeSql("insert into Property_table(name, type, price, bedroom, adddate, addtime, furniture, note, ylink, photosrc) values(" +
                           "'" +name + "','" + type + "','" + rentprice + "','" + bedroom + "','" + adddate + "','" + addtime + "','" + furniture + "','" + note + "','" + link + "','" + photosrc + "')");
         },dbError,function(tx) 
            {
               alert("Record successfully submitted");
               name="";
               type="";
               rentprice="";
               bedroom="";
               adddate="";
               addtime="";
               furniture="";
               note="";
               link="";
               photosrc="";
               window.location.href = "index.html";
            });            
      }
         
      function displayRecord()
      { 
         if (dbtablecount ==0) {  
         var dbObj2 = openDatabase(DBName, Version, DBDesc, DBsize);
         dbObj2.readTransaction(function(tx) 
         {
            tx.executeSql("SELECT * FROM Property_table order by id", [],		    
            function(tx, results) 
            {
               var rowStr = "";
               $Tableone = $("#tableone tbody");
               for(var i=0;i<results.rows.length;i++) 
               {
                  var row = results.rows.item(i);
                  rowStr += "<tr><td>" + row.id + "</td>"; 
                  rowStr += "<td>" + row.name + "</td>";
                  rowStr += "<td>" + row.type + "</td>";
                  rowStr += "<td>" + row.price + "</td>";
                  rowStr += "<td>" + row.adddate + "</td>";
                  rowStr += "</tr>";
               };
               $Tableone.empty();
               $Tableone.append(rowStr);
               if (dbtablecount ==0) {
               settable();
               dbtablecount=1;
            }   
            });
         },dbError);
         }
      }
      
      function settable()
      {
         table = $("#tableone").DataTable();
         $("#tableone tbody").on('click', 'tr', function () 
         {
            if ( $(this).hasClass('selected') ) 
            {
               $(this).removeClass('selected');
               rowselected = false;
            }
            else 
            {
               table.$('tr.selected').removeClass('selected');
               $(this).addClass('selected');
               rowselected = true;
            }
         });
      
         $("#dbutton").click(function () 
         {
            if (rowselected == true)
            {
               id_select = table.row('.selected').data();
               if (confirm("Confirm delete record (ID=" + id_select[0] + ")?")) 
               {
                  table.row('.selected').remove().draw( false );
                  delrecord();
               } 
               else 
               {
                  alert("Delete cancelled !");
               }
            }
            else if (rowselected == false)
            { 
               alert("please choose a record")
            }  
          })
      
         $("#ebutton").click(function () 
         {
            if (rowselected == true)
            {
               id_select = table.row('.selected').data();
               editrecord();
            }
            else if (rowselected == false)
            { alert("please choose a record")}
         })
      }
      
      function delrecord()   
      {
         dbObj.transaction(function(tx) 
         {
            tx.executeSql("delete from Property_table where id ='" + id_select[0] + "'");
         },dbError,function(tx) {alert("Record (ID=" + id_select[0]+ ") is successfully deleted");});
         rowselected = false;
      }
      
      function editrecord() 
      {
         window.location.href = "index.html#pedit";    
         var dbObj2 = openDatabase(DBName, Version, DBDesc, DBsize);
         dbObj2.readTransaction(function(tx) 
         {
      	   tx.executeSql("SELECT * FROM Property_table where id ='" + id_select[0] + "'", [],		    
            function(tx, results) 
            {
               var rowStr = "";
               $Tabletwo = $("#tabletwo tbody");
               for(var i=0;i<results.rows.length;i++) 
               {
                  var row = results.rows.item(i);
                  rowStr += "<tr><td style=width:30%>Record ID</td><td style=width:5%>:</td>"; 
                  rowStr += "<td style=width:65%>" + row.id + "</td></tr>"; 
                  rowStr += "<tr><td>Name</td><td>:</td>"; 
                  rowStr += "<td>" + row.name + "</td></tr>";
                  rowStr += "<tr><td>Type</td><td>:</td>"; 
                  rowStr += "<td>" + row.type + "</td></tr>";
                  rowStr += "<tr><td>Rent price</td><td>:</td>"; 
                  rowStr += "<td>" + row.price + "</td></tr>";
                  rowStr += "<tr><td>Adding date</td><td>:</td>"; 
                  rowStr += "<td>" + row.adddate + "</td></tr>";
                  rowStr += "<tr><td>Note</td><td>:</td>"; 
                  rowStr += "<td>" + row.note + "</td></tr>";
                  rowStr += "<tr><td>Youtube</td><td>:</td>"; 
                  rowStr += "<td>" + row.ylink + "</td></tr>";
                  rowStr += "<tr><td>Photo</td><td></td></tr>"; 
                  $("#txtareaone").text(row.note);
                  $("#ylink").val(row.ylink);
                  $("#extlink3").attr("youtubeid",$("#ylink").val());
                  $("#plink").val(row.photosrc);
                  $("#photoold").attr("src",$("#plink").val());
                  $("#photoshow").attr("src",$("#plink").val());
                  gotoyoutube();
               };
               $Tabletwo.empty();
               $Tabletwo.append(rowStr);
            });
         },dbError);
         rowselected = false;
      }
      
      function updaterecord() 
      {
         var notecontent;
         var ylinkcontent;
         notecontent=$("#txtareaone").val();
         ylinkcontent=$("#ylink").val();
         plinkcontent=$("#plink").val();
         var dbObj2 = openDatabase(DBName, Version, DBDesc, DBsize);
         dbObj2.transaction(function(tx) 
         {
      	   tx.executeSql("UPDATE Property_table set note='"+notecontent+"', ylink='" + ylinkcontent+ "', photosrc='" + plinkcontent + "' where id ='" + id_select[0] + "'", [], function(tx, results)
            {
               alert("Record (ID:"+id_select[0]+") has been updated");
               window.location.href = "index.html";
            });
         },dbError);
      }
      
      function gotoyoutube()
      {
         $(".youtube-link").grtyoutube();
      }
      
      function photoupload()
      {
         $("#photoshow").attr("src",$("#plink").val());
      }
   </script>
<style>
   .error
   {
      color: red;
      margin-left:2px
   };
</style>
</head>
<body>
   <div id="home" data-role="page">
      <div data-role="header">
         <h1 class="h1">Welcome to  RentalZ</h1>
      </div>
      <div data-role="content">
         <h2 align="center">Begin your journey with RentalZ</h2>
         <ul data-role="listview" data-inset="true">
            <li>
               <a href="#pcreate">
                  <img src="./images/home.svg" />
                  <h4>Create</h4>
                  <p>Enter information about your property</p>
               </a>
            </li>
            <li>
               <BR>
               <a href="#plist" onclick="displayRecord()">
                  <img src="./images/display.svg" />
                  <h4>Display, Search and Update</h4>
                  <p>List out details for all properties </p>
               </a>
            </li>
         </ul>
      </div>
      <div data-role="footer"  data-position="fixed">
         <h3>@Copyright RentalZ LTD</h3>
      </div>
   </div>
   <div id="pcreate" data-role="page">
      <div data-role="header">
         <h1>RentalZ</h1>
         <a href="#home">Back</a>
      </div>
      <div data-role="content">
         <h4 align="right"> * required field</h4>
         <form id="fcreate" method="get" action="">
            <div data-role="fieldcontain">
               <label for="name">Name of reporter *</label>
               <input id="name" name="name" minlength="3" required>
               <BR>
               <label for="rentprice">Monthly Rent Price (HKD) *</label>
               <input type="number" name="rentprice" min="1" max="99999999" id="rentprice" required>
               <BR>
               <label for="bedroom">No. of Bedroom(s) *</label>
               <input type="number" name="bedroom" min="0" max="99" id="bedroom" required>
               <BR>       
               <label for="type">Property type *</label>
               <select id="type" required>
                  <option value="">Please select</option>
                  <option value="bungalow">Bungalow</option>
                  <option value="cottage">Cottage</option>
                  <option value="detached">Detached</option>
                  <option value="flat">Flat</option>
                  <option value="house">House</option>
                  <option value="semidetached">Semi-detached</option>
                  <option value="other">Others</option>
               </select>
               <BR>
               <label for="adddate">Date and time of adding the Property *</label>		  
               <input type = "date" name = "adddate" id = "adddate" data-clear-btn = "true" required>
               </input>          
               <input type = "time" name = "addtime" id = "addtime"  data-clear-btn = "true" required>
               </input>
               <BR>
               <label for="furniture">Furniture</label>
               <select id="furniture">
                  <option value ="">Please select here</option>
                  <option value="furnished">Furnished</option>
                  <option value="partfurnished">Part Furnished</option>
                  <option value="unfurnished">Unfurnished</option>
               </select>
               <BR>
               <label for="note">Note</label>
               <input id="note" name="note">
               <BR>
               <label for="link">Youtube (video ID)</label>
               <input id="link" name="link">
               <BR>
               <label for="photosrc">Photo hyperlink</label>
               <input id="photosrc" name="photosrc">
            </div>
            <input class="submit" type="submit" value="Submit">
            <button id ="btn2" onclick="resetForm()">Reset</button>
         </form>
      </div>
   </div>
   <div id="plist" data-role="page" >
      <div data-role="header">
         <h1>Welcome to  RentalZ</h1>
         <a href="#home">Back</a>
      </div>
      <div data-role="fieldcontain">
         <table id="tableone" border="1">
            <thead>
               <tr>
                  <th>Record ID</th>
                  <th>Name</th>
                  <th>Type</th>
                  <th>Price</th>
                  <th>Date</th>
               </tr>
            </thead>
            <tbody>
            </tbody>
         </table>
         <table style="width:100%">
            <tr>
               <td style="width:50%">
                  <button id=dbutton>Delete</button>
               </td>
               <td style="width:50%">
                  <button id=ebutton>Edit</button>
               </td>
            </tr>
         </table>
      </div>
   </div>
   <div id="pedit" data-role="page">
      <div data-role="header">
         <h1>Welcome to  RentalZ</h1>
      </div>
      <h3 align="center">EDIT record</h3>
      <div id="editcontent" data-role="content">
         <table id="tabletwo" border="0">
            <tbody>
            </tbody>
         </table>
         <img id="photoold" src="" width=100%>
         <br>
         <h4>Here you can update the record</h4>
         <label for="txtareaone">Note : (e.g. condition, how close to public transportation)</label>
         <textarea name="txtareaone" id="txtareaone">
         </textarea>
         <br>
         <label for="ylink">Youtube video ID : <a href="#" id="extlink3" class="youtube-link" youtubeid="">Open last Video</a> </label>
         <input type="text" name="ylink" id="ylink">
         </input> 
         <br>
         <label for="plink">Photo Link of property</label>
         <input type=text id="plink">
         <button id="upbutton" onclick=photoupload()>Preview new link</button>
         <img id="photoshow" src="" width=100% >
         <div><h4 align="center">new photo preview</h4></div>
      </div>
      <table style="width:100%">
         <tr>
            <td style="width:50%">
               <button id=ubutton onclick="updaterecord()">Update</button>
            </td>
            <td style="width:50%">
               <button id=cbutton onclick=window.location.href="index.html">Cancel</button>
            </td>
         </tr>
      </table>
   </div>
</body>